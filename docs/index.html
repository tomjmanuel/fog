<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SF Fog Loop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      background: #05060a;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 1.5rem 1rem 2rem;
      box-sizing: border-box;
      gap: 1rem;
    }

    .stage {
      position: relative;
      max-width: 900px;
      width: 100%;
      aspect-ratio: 1 / 1;
      background: radial-gradient(circle at top, #1c2333, #05060a 60%);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0.25rem 1rem 1.5rem;
    }

    .stage img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      filter: drop-shadow(0 0 15px rgba(0, 0, 0, 0.8));
    }

    .timestamp-overlay {
      position: absolute;
      left: 0.8rem;
      bottom: 0.8rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.7);
      font-size: 0.8rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      white-space: nowrap;
    }

    .status-pill {
      position: absolute;
      right: 0.8rem;
      top: 0.8rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #20d37b;
      box-shadow: 0 0 8px #20d37b;
    }

    .frame-meta {
      max-width: 900px;
      width: 100%;
      font-size: 0.85rem;
      letter-spacing: 0.02em;
      opacity: 0.8;
    }

    .controls {
      display: flex;
      justify-content: flex-start;
      width: 100%;
      max-width: 900px;
    }

    .controls button {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.04);
      color: inherit;
      padding: 0.35rem 1.2rem;
      font: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 0.8rem;
    }

    .controls button:hover {
      background: rgba(255, 255, 255, 0.08);
    }
  </style>
</head>
<body>
  <div class="stage">
    <img id="frame-image" alt="Fog render sequence" />
    <div class="timestamp-overlay" id="timestamp-overlay">—</div>
    <div class="status-pill">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">Playing 2 fps</span>
    </div>
  </div>

  <div class="frame-meta" id="frame-count">Loading frames…</div>

  <div class="controls">
    <button id="latest-btn" type="button">Latest image</button>
  </div>

  <script>
    console.log("fog page script starting");

    window.addEventListener("error", (e) => {
      console.error("Global error:", e.message);
    });

    // === CONFIG ===
    const BUCKET = "fog-app-renders";
    const REGION = "us-west-1";
    const LOOP_FPS = 2;
    const LOOP_INTERVAL_MS = 1000 / LOOP_FPS;

    // Hardcoded list URL for now
    const LIST_URL =
      "https://fog-app-renders.s3.us-west-1.amazonaws.com/?list-type=2&prefix=daily/";

    let frames = [];
    let currentIndex = 0;
    let loopTimeoutId = null;
    let isPlaying = false;
    let lockedOnLatest = false;

    const imgEl = document.getElementById("frame-image");
    const tsEl = document.getElementById("timestamp-overlay");
    const statusTextEl = document.getElementById("status-text");
    const statusDotEl = document.getElementById("status-dot");
    const frameCountEl = document.getElementById("frame-count");
    const latestBtn = document.getElementById("latest-btn");

    function parseTimestampFromKey(key) {
      const filename = key.split("/").pop();
      const match = filename.match(
        /^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/
      );
      console.log("parseTimestampFromKey:", { key, filename, match });
      if (!match) return null;
      const [, year, month, day, hour, minute, second] = match;
      const date = new Date(
        Date.UTC(
          Number(year),
          Number(month) - 1,
          Number(day),
          Number(hour),
          Number(minute),
          Number(second)
        )
      );
      return date;
    }

    function formatTimestampForOverlay(date) {
      if (!date) return "Unknown time";
      const opts = {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        timeZone: "America/Los_Angeles",
        timeZoneName: "short"
      };
      return date.toLocaleString("en-US", opts);
    }

    function setStatusPlaying() {
      statusTextEl.textContent = "Playing 2 fps";
      statusDotEl.style.background = "#20d37b";
      statusDotEl.style.boxShadow = "0 0 8px #20d37b";
    }

    function setStatusLatest() {
      statusTextEl.textContent = "Latest frame";
      statusDotEl.style.background = "#ffae42";
      statusDotEl.style.boxShadow = "0 0 7px #ffae42";
    }

    function updateFrameCount() {
      if (frames.length === 0) {
        frameCountEl.textContent = "No frames available";
        return;
      }
      frameCountEl.textContent = `${frames.length} frames available`;
    }

    async function showFrame(index) {
      if (!frames.length) return;
      const frame = frames[index];
      if (!frame) return;
      imgEl.src = frame.url;
      tsEl.textContent = frame.label;
      if (typeof imgEl.decode === "function") {
        try {
          await imgEl.decode();
        } catch (err) {
          console.warn("decode failed", err);
        }
      } else if (!imgEl.complete) {
        await new Promise((resolve) => {
          imgEl.onload = imgEl.onerror = () => resolve();
        });
      }
    }

    function scheduleNextFrame() {
      if (!isPlaying || !frames.length) return;
      clearTimeout(loopTimeoutId);
      loopTimeoutId = setTimeout(async () => {
        if (!isPlaying || !frames.length) return;
        currentIndex = (currentIndex + 1) % frames.length;
        await showFrame(currentIndex);
        scheduleNextFrame();
      }, LOOP_INTERVAL_MS);
    }

    async function startLoop() {
      if (!frames.length) return;
      clearTimeout(loopTimeoutId);
      isPlaying = true;
      lockedOnLatest = false;
      latestBtn.textContent = "Latest image";
      setStatusPlaying();
      await showFrame(currentIndex);
      scheduleNextFrame();
    }

    function stopLoop() {
      isPlaying = false;
      clearTimeout(loopTimeoutId);
      loopTimeoutId = null;
    }

    async function fetchFrames() {
      console.log("fetchFrames() called");
      frameCountEl.textContent = "Loading frames…";
      try {
        const resp = await fetch(LIST_URL);
        console.log("List response status:", resp.status);
        const xmlText = await resp.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "application/xml");

        const contents = Array.from(xml.getElementsByTagName("Contents"));
        const items = contents
          .map((node) => {
            const key = node.getElementsByTagName("Key")[0].textContent;
            return key;
          })
          .filter((key) => key && key.endsWith(".png"));

        console.log("Contents length:", contents.length);
        console.log("PNG items:", items);

        const newFrames = items
          .map((key) => {
            const ts = parseTimestampFromKey(key);
            const segments = key.split("/").map(encodeURIComponent);
            const url = `https://${BUCKET}.s3.${REGION}.amazonaws.com/${segments.join(
              "/"
            )}`;
            return {
              key,
              url,
              timestampUtc: ts,
              label: ts ? formatTimestampForOverlay(ts) : key
            };
          })
          .filter((f) => !!f.timestampUtc);

        console.log("Parsed frames:", newFrames);

        newFrames.sort((a, b) => a.timestampUtc - b.timestampUtc);

        const previousKey =
          frames.length && frames[currentIndex] ? frames[currentIndex].key : null;

        frames = newFrames;
        if (!frames.length) {
          currentIndex = 0;
        } else if (lockedOnLatest) {
          currentIndex = frames.length - 1;
        } else if (previousKey) {
          const matchIdx = frames.findIndex((frame) => frame.key === previousKey);
          currentIndex = matchIdx >= 0 ? matchIdx : 0;
        } else {
          currentIndex = 0;
        }
        updateFrameCount();

        if (frames.length > 0) {
          if (isPlaying) {
            startLoop();
          } else {
            showFrame(currentIndex);
            if (lockedOnLatest) {
              setStatusLatest();
            }
          }
        }
      } catch (err) {
        console.error("Error in fetchFrames:", err);
        frameCountEl.textContent = "Error loading frames";
      }
    }

    latestBtn.addEventListener("click", async () => {
      if (!frames.length) return;
      if (!lockedOnLatest) {
        stopLoop();
        currentIndex = frames.length - 1;
        await showFrame(currentIndex);
        lockedOnLatest = true;
        setStatusLatest();
        latestBtn.textContent = "Resume loop";
      } else {
        startLoop();
      }
    });

    (async function init() {
      console.log("init() starting");
      await fetchFrames();
      if (frames.length) {
        currentIndex = 0;
        startLoop();
      }
      setInterval(fetchFrames, 60000);
    })();
  </script>
</body>
</html>
